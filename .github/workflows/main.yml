# .github/workflows/main.yml - å¢åŠ äº†ä»£ç†ç¯å¢ƒå˜é‡å’Œæ¨é€å†²çªä¿®å¤

name: 'Update schedule'

on:
  schedule:
    - cron: '0 10 */2 * *'
  workflow_dispatch:
    branches:
      - master
      - dev
      - gd
jobs:
  push:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [ 'ubuntu-latest' ]
    permissions:
      contents: write # ç¡®ä¿æ‹¥æœ‰æ¨é€æƒé™
      
    steps:
      - name: Set branch name
        id: vars
        run: echo "BRANCH_NAME=${{ github.repository_owner == 'Guovin' && 'gd' || 'master' }}" >> $GITHUB_ENV
      - uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH_NAME }}
      - name: Run with setup-python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          update-environment: true
          cache: 'pipenv'
          
      # ğŸ’¥ å®‰è£… FFmpegï¼Œä»¥æ”¯æŒåˆ†è¾¨ç‡æ£€æµ‹
      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
        
      # --- ç§»é™¤ä¸å¿…è¦çš„ Chrome æ£€æŸ¥ (å› ä¸º Actions ä¸é€‚åˆè¿è¡Œæµè§ˆå™¨) ---
      - name: Check open_driver config
        id: check_driver
        run: |
          echo "OPEN_DRIVER=False" >> $GITHUB_ENV # å¼ºåˆ¶ç¦ç”¨æµè§ˆå™¨æ¨¡å¼
      
      # --- å®‰è£…ä¾èµ– ---
      - name: Install pipenv
        run: pip3 install --user pipenv
      - name: Install dependecies
        run: pipenv --python 3.13 && pipenv install --deploy
        
      # ğŸ’¥ ä»£ç†åˆ†ç¦»æ ¸å¿ƒï¼šä»…åœ¨è¿è¡Œæ›´æ–°æ—¶è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡
      - name: Update (Proxy for Download, Direct for Speed Test) ğŸŒ
        env:
          # ğŸ’¥ è¯·åœ¨ GitHub Secrets ä¸­è®¾ç½® PROXY_URL ç¯å¢ƒå˜é‡
          HTTP_PROXY: ${{ secrets.PROXY_URL }} 
          HTTPS_PROXY: ${{ secrets.PROXY_URL }}
        run: |
          echo "--- Running Update Pipeline (Proxy Set for Downloads) ---"
          pipenv run dev # main.py åœ¨è¿è¡Œæ—¶ä¼šç»§æ‰¿è¿™äº›ç¯å¢ƒå˜é‡
          
      # ğŸ’¥ ä¿®å¤æ¨é€å†²çªï¼šä½¿ç”¨ --force
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "Github Action Auto Updated"
            # ä½¿ç”¨ --force è§£å†³å¹¶å‘æ›´æ–°æ—¶çš„æ¨é€å†²çª
            git push --force 
          fi
